Only in imgadm-smartos-live-c6f5e9955adbc4: CHANGES.md
Only in imgadm-smartos-live-c6f5e9955adbc4: Makefile
diff -r imgadm-smartos-live-c6f5e9955adbc4/README.md imgadm/README.md
1c1,9
< # imgadm -- manage VM images
---
> The initial imgadm import was imgadm from
> smartos-live@c6f5e9955adbc45688074ab1b8cac5d340262c56
> and is completely unmodified, other than the details below:
> 
> lib/locker.js and lib/zfs.js both come from smartos-live.git
> 
> package.json for this copy of imgadm differs from the smartos-live.git
> instance in order to pull in modern node-sdc-clients, needed so that
> imgadm (via buildimage) can compile using modern versions of node.
3,7c11,12
< `imgadm` is a tool for managing images on a local headnode or compute node. It
< can import and destroy local images, present information about how they're
< being used.  To find and install new images, imgadm speaks to a server
< implementing the IMGAPI. The default and canonical IMGAPI server is the Joyent
< Images repository at <https://images.joyent.com>.
---
> We also need a more modern bunyan and restify to avoid build errors
> in dtrace-provider when compiling with node v6.
9,70d13
< 
< # Test Suite
< 
<     /usr/img/test/runtests
< 
< This can only be run in the global zone (GZ).
< 
< 
< # Development
< 
< The src/img tree has not binary components, so you can get away
< with faster edit/test cycle than having to do a full smartos platform
< build and rebooting on it. Here is how:
< 
<     # On the target SmartOS GZ (e.g. MY-SMARTOS-BOX), make /usr/img
<     # and /usr/man/man1m writeable for testing:
<     ssh root@MY-SMARTOS-BOX
<     rm -rf /var/tmp/img \
<         && cp -RP /usr/img /var/tmp/img \
<         && mount -O -F lofs /var/tmp/img /usr/img \
<         && rm -rf /var/tmp/man1m \
<         && cp -RP /usr/man/man1m /var/tmp/man1m \
<         && mount -O -F lofs /var/tmp/man1m /usr/man/man1m
< 
<     # On a dev machine:
<     # Get a clone of the repo.
<     git clone git@github.com:joyent/smartos-live.git
<     cd src/img
< 
<     # Make edits, e.g. change the version:
<     vi package.json
< 
<     # Build a dev install image (in /var/tmp/img-install-image)
<     # and rsync that to the target node.
<     ./tools/dev-install root@MY-SMARTOS-BOX
< 
<     # Test that it worked by checking for the version change:
<     ssh root@MY-SMARTOS-BOX imgadm --version
< 
<     # Or run the test suite:
<     ssh root@MY-SMARTOS-BOX /var/img/test/runtests
< 
< 
< Before commits, please (a) run the test suite on a test box per the notes
< above and (b) maintain style by running `make check`.
< 
< 
< # /var/imgadm/imgadm.conf
< 
< "/var/imgadm/imgadm.conf" is imgadm's config file. Typically it should not be
< edited as most configuration is done via `imgadm ...` commands. For example,
< the list of image repository (IMGAPI) "sources" is controlled via
< `imgadm sources ...`.
< 
<     VAR             DESCRIPTION
<     sources         Array of image repository (IMGAPI) sources used for
<                     `imgadm avail`, `imgadm import`, etc. Use `imgadm sources`
<                     to control this value.
<     upgradedToVer   Automatically set by `imgadm` as it does any necessary
<                     internal DB migrations.
<     userAgentExtra  Optional string that is appended to the User-Agent header
<                     when talking to an IMGAPI source.
Only in imgadm-smartos-live-c6f5e9955adbc4: TODO.txt
Only in imgadm-smartos-live-c6f5e9955adbc4: etc
diff -r imgadm-smartos-live-c6f5e9955adbc4/lib/cli.js imgadm/lib/cli.js
1100c1100
<     var zpool = opts.P || common.DEFAULT_ZPOOL;
---
>     var zpool = opts.P || self.tool.DEFAULT_ZPOOL;
1135c1135
<             + common.DEFAULT_ZPOOL + '".'
---
>             + 'zones/<uuid>/data".'
1163c1163
<     var zpool = opts.P || common.DEFAULT_ZPOOL;
---
>     var zpool = opts.P || self.tool.DEFAULT_ZPOOL;
1247c1247
<             + common.DEFAULT_ZPOOL + '".'
---
>             + 'zones/<uuid>/data".'
1269c1269
<     var zpool = opts.P || common.DEFAULT_ZPOOL;
---
>     var zpool = opts.P || self.tool.DEFAULT_ZPOOL;
1303c1303
<             + common.DEFAULT_ZPOOL + '".'
---
>             + 'zones/<uuid>/data".'
1326c1326
<     var zpool = opts.P || common.DEFAULT_ZPOOL;
---
>     var zpool = opts.P || self.tool.DEFAULT_ZPOOL;
1351a1352,1353
>                 var logCb = opts.logCb || console.log;
> 
1362c1364
<                     console.log('Image %s%s is already installed, skipping',
---
>                     logCb('Image %s%s is already installed, skipping',
1480c1482
<             + common.DEFAULT_ZPOOL + '".'
---
>             + 'zones/<uuid>/data".'
1519c1521
<     var zpool = opts.P || common.DEFAULT_ZPOOL;
---
>     var zpool = opts.P || self.tool.DEFAULT_ZPOOL;
1621c1623
<             + common.DEFAULT_ZPOOL + '".'
---
>             + 'zones/<uuid>/data".'
diff -r imgadm-smartos-live-c6f5e9955adbc4/lib/common.js imgadm/lib/common.js
23c23
<  * Copyright (c) 2013, Joyent, Inc. All rights reserved.
---
>  * Copyright (c) 2018, Joyent, Inc. All rights reserved.
51d50
< var DEFAULT_ZPOOL = 'zones';
816d814
<     DEFAULT_ZPOOL: DEFAULT_ZPOOL,
diff -r imgadm-smartos-live-c6f5e9955adbc4/lib/imgadm.js imgadm/lib/imgadm.js
55c55
< var lock = require('/usr/img/node_modules/locker').lock;
---
> var lock = require('./locker.js').lock;
65c65
< var zfs = require('/usr/node/node_modules/zfs.js').zfs;
---
> var zfs = require('./zfs.js').zfs;
86a87
> var DEFAULT_SDC_VERSION = '7.0';
91,92c92,95
< var VMADM_FS_NAME_RE = /^([a-zA-Z][a-zA-Z\._-]*)\/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})(-disk\d+)?$/;
< var VMADM_IMG_NAME_RE = /^([a-zA-Z][a-zA-Z\._-]*)\/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})$/;
---
> // In zones, we don't have 'SDC Version' in sysinfo, but we know
> // we're always at least SDC 7.0.
> var VMADM_FS_NAME_RE = /^([a-zA-Z0-9][a-zA-Z0-9\/\._-]*)\/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})(-disk\d+)?$/;
> var VMADM_IMG_NAME_RE = /^([a-zA-Z0-9][a-zA-Z0-9\/\._-]*)\/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})$/;
141c144
<     var platVer = opts.sysinfo['SDC Version'] || '6.5';
---
>     var platVer = opts.sysinfo['SDC Version'] || DEFAULT_SDC_VERSION;
409a413,467
>     var zonename;
> 
>     function findZonename(next) {
>         execFile('/usr/bin/zonename', function _zonename(err, stdout, stderr) {
>             if (!err) {
>                 zonename = stdout.trim();
>                 if (zonename === 'global') {
>                     cb(new errors.UsageError('this version of imgadm only '
>                         + 'supports non-global zones'));
>                     return;
>                 }
>             }
>             next(err);
>         });
>     }
> 
>     function findZonesPool(next) {
>         execFile('/usr/sbin/zpool', [
>             'list',
>             '-Hpo',
>             'name'
>         ], function _onZpoolList(err, stdout, stderr) {
>             if (!err) {
>                 if (stdout.trim() !== 'zones') {
>                     cb(new errors.UsageError('this version of imgadm only '
>                         + 'supports zpools named "zones"'));
>                     return;
>                 }
>             }
>             next(err);
>         });
>     }
> 
>     function findDelegated(next) {
>         var dsname = 'zones/' + zonename + '/data';
> 
>         execFile('/usr/sbin/zfs', [
>             'list',
>             '-Hpo',
>             'name',
>             dsname
>         ], function _onZpoolList(err, stdout, stderr) {
>             if (!err) {
>                 if (stdout.trim() !== dsname) {
>                     cb(new errors.UsageError('this version of imgadm only '
>                         + 'supports zones with delegated datasets named '
>                         + '"data"'));
>                     return;
>                 }
>                 self.DEFAULT_ZPOOL = common.DEFAULT_ZPOOL = dsname;
>             }
>             next(err);
>         });
>     }
> 
454a513,515
>         findZonename,
>         findZonesPool,
>         findDelegated,
873a935
> 
875a938
> 
2652a2716,2719
>                 if (chunk.toString()
>                     .match(/SMF Initialization problems..svc:\//)) {
>                     return;
>                 }
2656a2724,2727
>                 if (chunk.toString()
>                     .match(/NFS plugin problem with SMF repository:/)) {
>                     return;
>                 }
3304a3376,3377
>     assert.optionalFunc(options.vmGet, 'options.vmGet');
> 
3326c3399,3401
<             common.vmGet(vmUuid, {log: log}, function (err, vm) {
---
>             var vmGet = options.vmGet || common.vmGet;
> 
>             vmGet(vmUuid, {log: log}, function (err, vm) {
3835c3910,3916
<                 compressor = spawn('/usr/bin/gzip', ['-cfq']);
---
>                 if (fs.existsSync('/opt/local/bin/pigz')) {
>                     logCb('Compressing image with pigz');
>                     compressor = spawn('/opt/local/bin/pigz', ['-cfq']);
>                 } else {
>                     logCb('Compressing image with gzip');
>                     compressor = spawn('/usr/bin/gzip', ['-cfq']);
>                 }
Only in imgadm/lib: locker.js
Only in imgadm/lib: zfs.js
Only in imgadm-smartos-live-c6f5e9955adbc4: man
Only in imgadm-smartos-live-c6f5e9955adbc4: node_modules
Only in imgadm: package-lock.json
diff -r imgadm-smartos-live-c6f5e9955adbc4/package.json imgadm/package.json
11c11
<     "bunyan": "1.3.5",
---
>     "bunyan": "1.8.12",
17a18
>     "lockfd": "2.0.1",
22c23
<     "restify": "2.8.5",
---
>     "restify": "7.2.2",
24c25
<     "sdc-clients": "git://github.com/joyent/node-sdc-clients.git#29dea8e",
---
>     "sdc-clients": "git://github.com/joyent/node-sdc-clients.git#28209ab",
Only in imgadm-smartos-live-c6f5e9955adbc4/sbin: chroot-gtar
Only in imgadm-smartos-live-c6f5e9955adbc4/sbin: gtar-unlink-dir
diff -r imgadm-smartos-live-c6f5e9955adbc4/sbin/imgadm imgadm/sbin/imgadm
24c24
<  * Copyright (c) 2013, Joyent, Inc. All rights reserved.
---
>  * Copyright (c) 2018, Joyent, Inc. All rights reserved.
31d30
< var onlyif = require('/usr/node/node_modules/onlyif');
37,44c36,37
<     onlyif.rootInSmartosGlobal(function (onlyifErr) {
<         if (onlyifErr) {
<             console.error('imgadm: error: cannot run: ' + onlyifErr);
<             process.exit(2);
<         }
<         var cli = new CLI();
<         cmdln.main(cli, {argv: argv, showCode: true});
<     });
---
>     var cli = new CLI();
>     cmdln.main(cli, {argv: argv, showCode: true});
Only in imgadm-smartos-live-c6f5e9955adbc4: test
Only in imgadm-smartos-live-c6f5e9955adbc4: tools
